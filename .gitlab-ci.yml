stages:
  - build

variables:
  IMAGE: $CI_REGISTRY_IMAGE

Build image:
  stage: build
  image: docker:20
  only:
    refs:
      - development
  services:
    - docker:20-dind
  before_script:
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" $CI_REGISTRY
  script:
    - docker image pull ${IMAGE}:latest || true 
    - >
      docker build 
      --pull 
      --cache-from ${IMAGE}:latest 
      --tag ${IMAGE}:dev
      .
    - docker push ${IMAGE}:dev

Build latest:
  image: docker:20
  services:
    - docker:20-dind
  variables:
    GIT_STRATEGY: none
  stage: build
  only:
    refs:
      - main
  before_script:
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" $CI_REGISTRY
  script:
    - docker pull $IMAGE:dev
    - docker tag $IMAGE:dev $IMAGE:latest
    - docker push $IMAGE:latest
